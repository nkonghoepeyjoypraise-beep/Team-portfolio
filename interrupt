#!/usr/bin/env bash
# monitor_interrupts.sh
# Usage: sudo ./monitor_interrupts.sh idle|io|cpu duration_sec

set -euo pipefail
WORKLOAD=${1:-idle}
DUR=${2:-20}

function snapshot() {
  # Sum of all non-CPU-column numbers per IRQ line since boot
  awk '
    /^[ 0-9]+:/ {
      sum=0
      for (i=2; i<=NF; i++) {
        if ($i ~ /^[0-9]+$/) sum+= $i
      }
      print $1, sum
    }
  ' /proc/interrupts
}

function run_workload() {
  case "$WORKLOAD" in
    idle)
      sleep "$DUR"
      ;;
    io)
      dd if=/dev/zero of=/tmp/int_test bs=4M count=64 status=none &
      DD_PID=$!
      sleep "$DUR"
      kill "$DD_PID" 2>/dev/null || true
      rm -f /tmp/int_test
      ;;
    cpu)
      # Lightweight CPU stress using bc loop
      end=$(( $(date +%s) + DUR ))
      while [ "$(date +%s)" -lt "$end" ]; do
        echo 'scale=3; a(1)*4' | bc -l >/dev/null
      done
      ;;
    *)
      echo "Unknown workload: $WORKLOAD"; exit 1;
      ;;
  esac
}

echo "Taking baseline snapshot..."
snapshot > /tmp/ints_before.txt
echo "Running workload: $WORKLOAD for ${DUR}s..."
run_workload
echo "Taking final snapshot..."
snapshot > /tmp/ints_after.txt

echo "Delta per IRQ:"
paste /tmp/ints_before.txt /tmp/ints_after.txt | awk '
{
  # fields: IRQ: before_sum | IRQ: after_sum
  split($1, a, ":"); split($3, b, ":");
  if (a[1] == b[1]) {
    before=$2; after=$4;
    if (before ~ /^[0-9]+$/ && after ~ /^[0-9]+$/) {
      printf "%-6s %12d\n", a[1], (after - before);
    }
  }
}
' | sort -k2,2nr
